name: CD - Deploy

on:
  # å½“ CI å·¥ä½œæµå®Œæˆæ—¶è§¦å‘
  workflow_run:
    workflows: ["CI - Backend", "CI - Frontend"]
    types:
      - completed
    branches: [main, dev]
  # æ”¯æŒ tag æŽ¨é€
  push:
    tags:
      - 'v*'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}-backend
  FRONTEND_IMAGE: ${{ github.repository }}-frontend

jobs:
  # æ£€æŸ¥ CI æ˜¯å¦æˆåŠŸ
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    # ä»…å½“ workflow_run è§¦å‘æ—¶æ£€æŸ¥ï¼Œtag å’Œæ‰‹åŠ¨è§¦å‘è·³è¿‡
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI result
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… CI passed, proceeding with deployment"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "âŒ CI failed, skipping deployment"
              exit 1
            fi
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Tag push or manual trigger, proceeding with deployment"
          fi

  # æž„å»ºåŽç«¯é•œåƒ
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: check-ci
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Build and push Backend
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # æž„å»ºå‰ç«¯é•œåƒ
  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: check-ci
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Build and push Frontend
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./frontend-web
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/dev' || (startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-'))
    environment: development
    concurrency:
      group: deploy-development
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEV_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEV_HOST }} >> ~/.ssh/known_hosts

      - name: Create and copy deployment files
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾éƒ¨ç½²æ–‡ä»¶
          DEPLOY_TMP=$(mktemp -d)
          trap "rm -rf $DEPLOY_TMP" EXIT

          # å¤åˆ¶ docker-compose.yml
          cp backend/docker-compose.yml "$DEPLOY_TMP/docker-compose.yml"
          
          # ä½¿ç”¨ heredoc å®‰å…¨å†™å…¥æ•æ„Ÿæ–‡ä»¶
          cat > "$DEPLOY_TMP/cert.pem" << 'EOF'
          ${{ secrets.DEV_SSL_CERT }}
          EOF
          
          cat > "$DEPLOY_TMP/private.key" << 'EOF'
          ${{ secrets.DEV_SSL_KEY }}
          EOF
          
          cat > "$DEPLOY_TMP/.env" << 'EOF'
          ${{ secrets.DEV_ENV_FILE }}
          EOF
          
          cat > "$DEPLOY_TMP/nginx.conf" << 'EOF'
          ${{ secrets.DEV_NGINX_CONF }}
          EOF
          
          # å¤åˆ¶æ–‡ä»¶åˆ°æœåŠ¡å™¨
          scp "$DEPLOY_TMP/docker-compose.yml" "${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEV_DEPLOY_PATH }}/docker-compose.yml"
          scp "$DEPLOY_TMP/cert.pem" "${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEV_DEPLOY_PATH }}/certs/cert.pem"
          scp "$DEPLOY_TMP/private.key" "${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEV_DEPLOY_PATH }}/certs/private.key"
          scp "$DEPLOY_TMP/.env" "${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEV_DEPLOY_PATH }}/.env"
          scp "$DEPLOY_TMP/nginx.conf" "${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEV_DEPLOY_PATH }}/nginx.conf"
        shell: bash

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.DEV_DEPLOY_PATH }}
            
            # è®¾ç½®è¯ä¹¦æƒé™
            chmod 600 certs/private.key
            chmod 644 certs/cert.pem

            # è®¾ç½®é•œåƒæ ‡ç­¾
            export TAG=dev

            # æ‹‰å–å¹¶å¯åŠ¨å®¹å™¨
            docker compose pull
            docker compose up -d --remove-orphans
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f
            
            echo "âœ… Development deployment completed at $(date)"

  # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main' || (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-'))
    environment: production
    concurrency:
      group: deploy-production
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Create and copy deployment files
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾éƒ¨ç½²æ–‡ä»¶
          DEPLOY_TMP=$(mktemp -d)
          trap "rm -rf $DEPLOY_TMP" EXIT

          # å¤åˆ¶ docker-compose.yml
          cp backend/docker-compose.yml "$DEPLOY_TMP/docker-compose.yml"
          
          # ä½¿ç”¨ heredoc å®‰å…¨å†™å…¥æ•æ„Ÿæ–‡ä»¶
          cat > "$DEPLOY_TMP/cert.pem" << 'EOF'
          ${{ secrets.PROD_SSL_CERT }}
          EOF
          
          cat > "$DEPLOY_TMP/private.key" << 'EOF'
          ${{ secrets.PROD_SSL_KEY }}
          EOF
          
          cat > "$DEPLOY_TMP/.env" << 'EOF'
          ${{ secrets.PROD_ENV_FILE }}
          EOF
          
          cat > "$DEPLOY_TMP/nginx.conf" << 'EOF'
          ${{ secrets.PROD_NGINX_CONF }}
          EOF
          
          # å¤åˆ¶æ–‡ä»¶åˆ°æœåŠ¡å™¨
          scp "$DEPLOY_TMP/docker-compose.yml" "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_DEPLOY_PATH }}/docker-compose.yml"
          scp "$DEPLOY_TMP/cert.pem" "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_DEPLOY_PATH }}/certs/cert.pem"
          scp "$DEPLOY_TMP/private.key" "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_DEPLOY_PATH }}/certs/private.key"
          scp "$DEPLOY_TMP/.env" "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_DEPLOY_PATH }}/.env"
          scp "$DEPLOY_TMP/nginx.conf" "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_DEPLOY_PATH }}/nginx.conf"
        shell: bash

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.PROD_DEPLOY_PATH }}
            
            # è®¾ç½®è¯ä¹¦æƒé™
            chmod 600 certs/private.key
            chmod 644 certs/cert.pem

            # è®¾ç½®é•œåƒæ ‡ç­¾
            export TAG=main

            # æ‹‰å–å¹¶å¯åŠ¨å®¹å™¨
            docker compose pull
            docker compose up -d --remove-orphans
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f
            
            echo "âœ… Production deployment completed at $(date)"
