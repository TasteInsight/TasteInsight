// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // 或 "mysql"
  url      = env("DATABASE_URL")
}

// ==================== 用户相关模型 ====================

model User {
  id        String   @id @default(cuid())
  openId    String   @unique
  nickname  String
  avatar    String?
  allergens String[] @default([]) // 过敏原列表

  // 关联关系
  preferences    UserPreference?
  settings       UserSetting?
  reviews        Review[]
  comments       Comment[]
  mealPlans      MealPlan[]
  uploads        DishUpload[]
  reports        Report[]
  favoriteDishes FavoriteDish[]
  browseHistory  BrowseHistory[]

  aiSessions AISession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model UserPreference {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 基础偏好
  tagPreferences String[] @default([]) // 菜系偏好

  // 价格偏好
  priceMin Float @default(0)
  priceMax Float @default(50)

  // 肉类和食材偏好
  meatPreference      String[] @default([])
  avoidIngredients    String[] @default([]) // 不喜欢的食材
  favoriteIngredients String[] @default([]) // 喜欢的食材

  // 口味偏好
  spicyLevel Int @default(0) // 0-5 辣度等级
  sweetness  Int @default(0) // 0-5
  saltiness  Int @default(0) // 0-5
  oiliness   Int @default(0) // 0-5

  // 其他偏好
  canteenPreferences String[] @default([]) // 偏好食堂ID列表
  portionSize        String   @default("medium") // small, medium, large

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model UserSetting {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 通知设置
  newDishAlert         Boolean @default(true)
  priceChangeAlert     Boolean @default(false)
  reviewReplyAlert     Boolean @default(true)
  weeklyRecommendation Boolean @default(true)

  // 显示设置
  showCalories  Boolean @default(true)
  showNutrition Boolean @default(false)
  defaultSortBy String  @default("rating") // rating, price_low, price_high, popularity, newest

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

// ==================== 管理员相关模型 ====================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String // 应该存储哈希后的密码
  role      String   @default("admin")
  canteenId String?
  canteen   Canteen? @relation(fields: [canteenId], references: [id])

  createdBy String? // 创建者ID
  creator   Admin?  @relation("AdminHierarchy", fields: [createdBy], references: [id])
  subAdmins Admin[] @relation("AdminHierarchy")

  // 权限
  permissions AdminPermission[]

  // 操作记录
  operationLogs  OperationLog[]
  createdNews    News[]
  handledReports Report[]       @relation("ReportHandler")
  dishUploads    DishUpload[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model AdminPermission {
  id         String @id @default(cuid())
  adminId    String
  admin      Admin  @relation(fields: [adminId], references: [id], onDelete: Cascade)
  permission String // 如: "dish:view", "dish:create", "dish:edit", "dish:delete", "review:approve", 等

  @@unique([adminId, permission])
  @@map("admin_permissions")
}

model OperationLog {
  id      String @id @default(cuid())
  adminId String
  admin   Admin  @relation(fields: [adminId], references: [id])

  action     String // 操作类型
  targetType String // 操作对象类型
  targetId   String // 操作对象ID
  details    Json? // 操作详情
  result     String // success, failure

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("operation_logs")
}

// ==================== 食堂和窗口模型 ====================

model Canteen {
  id          String   @id @default(cuid())
  name        String
  position    String?
  description String?
  images      String[]

  // 营业时间
  openingHours Json // 存储复杂的营业时间结构

  // 统计信息
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  // 关联关系
  floors       Floor[]
  windows      Window[]
  dishes       Dish[]
  dishUploads  DishUpload[]
  news         News[]
  admins       Admin[]
  adminConfigs AdminConfig[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("canteens")
}

model Window {
  id        String  @id @default(cuid())
  canteenId String
  canteen   Canteen @relation(fields: [canteenId], references: [id], onDelete: Cascade)
  floorId   String?
  floor     Floor?  @relation(fields: [floorId], references: [id])

  name        String
  number      String // 窗口号
  position    String?
  description String?
  tags        String[] // 特色标签

  // 关联关系
  dishes      Dish[]
  dishUploads DishUpload[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([canteenId])
  @@map("windows")
}

model Floor {
  id        String  @id @default(cuid())
  canteenId String
  canteen   Canteen @relation(fields: [canteenId], references: [id], onDelete: Cascade)

  level String // 楼层
  name  String? // 楼层名称

  dish   Dish[] // 该楼层的菜品（可选关联）
  window Window[] // 该楼层的窗口（可选关联）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([canteenId])
  @@map("floors")
}

// ==================== 菜品相关模型 ====================

model Dish {
  id          String   @id @default(cuid())
  name        String
  tags        String[]
  price       Float
  priceUnit   String?
  description String?
  images      String[]

  // 菜品层级关系
  parentDishId     String?
  parentDish       Dish?        @relation("DishHierarchy", fields: [parentDishId], references: [id])
  subDishes        Dish[]       @relation("DishHierarchy")
  pendingSubDishes DishUpload[] @relation("DishParentToUpload")

  // 食材信息
  ingredients String[]
  allergens   String[]

  // 口味信息
  spicyLevel Int @default(0) // 0-5 辣度等级
  sweetness  Int @default(0) // 0-5 甜度
  saltiness  Int @default(0) // 0-5 咸度
  oiliness   Int @default(0) // 0-5 油度

  // 位置信息
  canteenId    String
  canteen      Canteen @relation(fields: [canteenId], references: [id], onDelete: Cascade)
  canteenName  String
  floorId      String?
  floor        Floor?  @relation(fields: [floorId], references: [id])
  floorLevel   String?
  floorName    String?
  windowId     String?
  window       Window? @relation(fields: [windowId], references: [id])
  windowNumber String?
  windowName   String

  // 供应时间
  availableMealTime String[] // breakfast, lunch, dinner, nightsnack
  availableDates    Json? // 可用日期范围数组

  // 状态
  status String @default("online") // online, offline

  // 统计信息
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  // 关联关系
  reviews       Review[]
  favoritedBy   FavoriteDish[]
  mealPlans     MealPlanDish[]
  browseHistory BrowseHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([canteenId])
  @@index([windowId])
  @@index([status])
  @@index([averageRating])
  @@map("dishes")
}

model DishUpload {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  adminId String?
  admin   Admin?  @relation(fields: [adminId], references: [id])

  parentDishId String?
  parentDish   Dish?   @relation("DishParentToUpload", fields: [parentDishId], references: [id])

  // 菜品信息（与Dish模型类似）
  name        String
  tags        String[]
  price       Float
  priceUnit   String?
  description String?
  images      String[]
  ingredients String[]
  allergens   String[]

  // 口味信息
  spicyLevel Int @default(0) // 0-5 辣度等级
  sweetness  Int @default(0) // 0-5 甜度
  saltiness  Int @default(0) // 0-5 咸度
  oiliness   Int @default(0) // 0-5 油度

  // 位置信息
  canteenId    String
  canteen      Canteen @relation(fields: [canteenId], references: [id], onDelete: Cascade)
  canteenName  String
  // 转正后填充 楼层
  windowId     String?
  window       Window? @relation(fields: [windowId], references: [id])
  windowNumber String?
  windowName   String

  // 供应时间
  availableMealTime String[] // breakfast, lunch, dinner, nightsnack
  availableDates    Json? // 可用日期范围数组

  // 审核状态
  status         String  @default("pending") // pending, approved, rejected
  rejectReason   String?
  approvedDishId String? // 审核通过后对应的菜品ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([adminId])
  @@index([status])
  @@map("dish_uploads")
}

// ==================== 评价和评论模型 ====================

model Review {
  id     String @id @default(cuid())
  dishId String
  dish   Dish   @relation(fields: [dishId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id])

  rating  Int // 1-5
  content String?
  images  String[]

  // 详细评分
  spicyLevel Int? // 1-5
  sweetness  Int? // 1-5
  saltiness  Int? // 1-5
  oiliness   Int? // 1-5

  status       String  @default("pending") // pending, approved, rejected
  rejectReason String?

  // 关联关系
  comments Comment[]
  reports  Report[]

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dishId])
  @@index([userId])
  @@index([status])
  @@index([deletedAt])
  @@map("reviews")
}

model Comment {
  id       String @id @default(cuid())
  reviewId String
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  content String
  floor   Int    @default(1) // 楼层数

  parentCommentId String?
  parentComment   Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")

  status       String  @default("pending") // pending, approved, rejected
  rejectReason String?

  // 关联关系
  reports Report[]

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reviewId])
  @@index([userId])
  @@index([status])
  @@index([parentCommentId])
  @@index([deletedAt])
  @@map("comments")
}

model Report {
  id         String @id @default(cuid())
  reporterId String
  reporter   User   @relation(fields: [reporterId], references: [id])

  targetType String // review, comment
  targetId   String

  // 关联到具体目标（可选，用于方便查询）
  reviewId  String?
  review    Review?  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  type   String // inappropriate, spam, false_info, other
  reason String

  status       String    @default("pending") // pending, approved, rejected
  handleResult String?
  handledBy    String?
  handler      Admin?    @relation("ReportHandler", fields: [handledBy], references: [id])
  handledAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reporterId])
  @@index([targetType, targetId])
  @@index([status])
  @@map("reports")
}

// ==================== 用户行为模型 ====================

model FavoriteDish {
  id      String   @id @default(cuid())
  userId  String
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dishId  String
  dish    Dish     @relation(fields: [dishId], references: [id], onDelete: Cascade)
  addedAt DateTime @default(now())

  @@unique([userId, dishId])
  @@index([userId])
  @@map("favorite_dishes")
}

model BrowseHistory {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dishId   String
  dish     Dish     @relation(fields: [dishId], references: [id], onDelete: Cascade)
  viewedAt DateTime @default(now())

  @@index([userId])
  @@index([viewedAt])
  @@map("browse_history")
}

// ==================== 饮食规划模型 ====================

model MealPlan {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  mealTime  String // breakfast, lunch, dinner, nightsnack

  // 关联关系
  dishes MealPlanDish[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("meal_plans")
}

model MealPlanDish {
  id         String   @id @default(cuid())
  mealPlanId String
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  dishId     String
  dish       Dish     @relation(fields: [dishId], references: [id], onDelete: Cascade)

  @@unique([mealPlanId, dishId])
  @@map("meal_plan_dishes")
}

// ==================== AI聊天模型 ====================

model AISession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  scene String @default("general_chat") // general_chat, meal_planner, dish_critic

  messages AIMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("ai_sessions")
}

model AIMessage {
  id        String    @id @default(cuid())
  sessionId String
  session   AISession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role    String // user, assistant
  content Json // Array of content segments (text, card_dish, card_plan, card_canteen)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([createdAt])
  @@map("ai_messages")
}

model AIConfig {
  id       String @id @default(cuid())
  key      String @unique
  value    String
  category String @default("general") // provider, model, api

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_configs")
}

// ==================== 推荐系统事件日志 ====================

model RecommendationEvent {
  id        String @id @default(cuid())
  eventType String // impression, click, favorite, review, dislike
  userId    String
  dishId    String

  // 推荐上下文
  scene     String // home, search, similar, guess_like, today
  requestId String? // 推荐请求ID，用于追踪
  position  Int? // 菜品在列表中的位置
  score     Float? // 推荐分数

  // A/B 测试
  experimentId String? // 实验ID
  groupItemId  String? // 实验组ID

  // 额外数据
  extra Json? // 存储额外的事件数据

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([dishId])
  @@index([eventType])
  @@index([scene])
  @@index([requestId])
  @@index([experimentId])
  @@index([createdAt])
  @@map("recommendation_events")
}

// ==================== A/B 测试实验配置 ====================

model Experiment {
  id          String  @id @default(cuid())
  name        String
  description String?

  // 流量配置
  trafficRatio Float @default(0) // 0-1 实验流量比例，比如 0.2 = 20% 用户参与实验

  // 时间配置
  startTime DateTime
  endTime   DateTime?

  // 状态
  status String @default("draft") // draft, running, completed, paused

  // 实验分组项列表
  groupItems ExperimentGroupItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([startTime, endTime])
  @@map("experiments")
}

model ExperimentGroupItem {
  id           String     @id @default(cuid())
  experimentId String // 所属实验ID
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  name  String // 分组名称（如：control, variant_a）
  ratio Float // 流量比例，所有分组项的 ratio 加起来应为 1

  // 实验配置（JSON格式存储）
  // 可包含：weights（权重配置）、recallQuota（召回配额）等
  config Json? // { weights: {...}, recallQuota: {...}, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([experimentId, name])
  @@index([experimentId])
  @@map("experiment_group_items")
}

// ==================== 用户实验分组分配 ====================

model UserExperimentAssignment {
  id           String @id @default(cuid())
  userId       String
  experimentId String // 参与的实验ID
  groupItemId  String // 分配的实验组ID

  assignedAt DateTime @default(now())

  @@unique([userId, experimentId])
  @@index([userId])
  @@index([experimentId])
  @@index([groupItemId])
  @@map("user_experiment_assignments")
}

// ==================== 菜品向量嵌入 ====================

model DishEmbedding {
  id     String @id @default(cuid())
  dishId String @unique

  // 向量嵌入（使用 PostgreSQL pgvector 扩展）
  // Prisma 目前不原生支持 vector 类型，使用 Unsupported 标记
  // 实际数据类型将在迁移文件中定义为 vector
  embedding Unsupported("vector")? // Float[] 向量数据，存储为 pgvector

  // 元数据
  version   String   @default("v1") // 嵌入版本（v1, v2, v3）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dishId])
  @@index([version])
  @@map("dish_embeddings")
}

// ==================== 新闻模型 ====================

model News {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text
  summary     String?
  canteenId   String?
  canteen     Canteen?  @relation(fields: [canteenId], references: [id])
  canteenName String?
  publishedAt DateTime?
  status      String    @default("draft") // draft, published
  createdBy   String
  creator     Admin     @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([canteenId])
  @@index([publishedAt])
  @@index([status])
  @@map("news")
}

// ==================== 管理配置模型 ====================

model AdminConfig {
  id        String   @id @default(cuid())
  canteenId String?  @unique // null 表示全局配置
  canteen   Canteen? @relation(fields: [canteenId], references: [id], onDelete: Cascade)

  // 配置项列表
  items AdminConfigItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_configs")
}

model AdminConfigTemplate {
  id           String  @id @default(cuid())
  key          String  @unique // 如 'review.autoApprove'
  defaultValue String // 默认值，统一用 string 存储
  valueType    String  @default("string") // 'boolean' | 'string' | 'number' | 'json'
  description  String?
  category     String  @default("general") // 'review' | 'dish' | 'user'

  // 配置项实例
  configItems AdminConfigItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_config_templates")
}

model AdminConfigItem {
  id            String      @id @default(cuid())
  adminConfigId String
  adminConfig   AdminConfig @relation(fields: [adminConfigId], references: [id], onDelete: Cascade)

  templateId String? // 关联到模板
  template   AdminConfigTemplate? @relation(fields: [templateId], references: [id])

  key       String // 如 'review.autoApprove'
  value     String // 统一用 string 存储，应用层转换
  valueType String @default("string") // 'boolean' | 'string' | 'number' | 'json'

  description String?
  category    String  @default("general") // 'review' | 'dish' | 'user'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([adminConfigId, key])
  @@map("admin_config_items")
}
